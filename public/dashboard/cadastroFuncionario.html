<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/dashboard/cadastroFuncionario.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link rel="icon" href="../assets/icon/icon.png" />

    <title>Cadastro de Funcionários - Alianza</title>
</head>

<body onload="listarFunc()">

    <!--Inicio -  Pop-up de edição de funcionário -->
    <div class="sombra" id="sombraDiv" onclick="sairModal()"></div>
    <div class="modal" id="modalDiv">
        <div class="formCadastro">
            <div class="img_voltar">
                <img src="../assets/icon/seta-circulada.png" onclick="sairModal()">
                <h1>Editar</h1>
            </div>
            <div class="inputForm">
                <span>Nome:</span>
                <input type="text" id="nome_input">
                <span>Nivel de acesso:</span>
                <select name="name-select-acesso" class="select-acesso" id="select_tipoUsuario">
                    <option value="#" default>Selecione</option>
                    <option value="1">Gerente</option>
                    <option value="2">Analista</option>
                </select>
                <span>Email:</span>
                <input type="text" id="input_email">
                <span>Senha:</span>
                <input type="password" id="input_senha">
            </div>
            <button onclick="editarFunc()" class="cadastrarFunc">Confirmar</button>
        </div>
    </div>
    <!--Fim -  Pop-up de edição de funcionário -->

    <div>
        <!-- Aqui começa o menu, quando for fazer outro arquivo copie aqui -->
        <div id="menu" class="hidden">
            <div id="div-fechar-menu">
                <img id="imgCloseMenu" class="imgMenu" src="../assets/imgs/menu.png" alt="">
                <img id="imgLogo" src="../assets/imgs/alianza_logo.png" alt="">
            </div>
            <div id="div-usuario">
                <div id="img-usuario"></div>
                <p>Olá, Usuário</p>
            </div>
            <ul>
                <li><a href="./dashboard.html">Dashboard</a></li>
                <li><a href="./relatorios.html">Relatórios Mensais</a></li>
                <li><a href="./rotasProblematicas.html">Rotas Problemáticas</a></li>
                <li><a href="./performanceOperacional.html">Performance Operacional</a></li>
                <li><a href="./sugestoesGemini.html">Sugestões Gemini</a></li>
                <li><b><a href="./cadastroFuncionario.html">Cadastro de Funcionários</a></b></li>
            </ul>
            <div id="div-configuracao">
                <a href="./configuracoes.html">
                    <div id="caixa-config">
                        <img src="../assets/imgs/image 9.png" alt="">
                        <p><b>Configurações</b></p>
                    </div>
                </a>
            </div>
        </div>
        <!-- Aqui o menu acaba, copie até aqui -->

        <!-- Aqui começa a "navzinha" digamos assim, copie a partir daqui também-->
        <div id="div-nav">
            <div id="caixa-nav">
                <img id="imgOpenMenu" class="imgMenu" src="../assets/imgs/menu.png" alt="">
                <h1>CADASTRO DE FUNCIONÁRIOS</h1>
            </div>
            <img id="imgLogo" src="../assets/imgs/alianza_logo.png" alt="">
        </div>
        <!-- Aqui termina a "navzinha", termine de copiar aqui -->


        <div class="box-cadastro">

            <!-- Inicio - Inputs -->
            <div class="formCadastro">
                <div class="inputForm">
                    <span>Nome:</span>
                    <input type="text" id="nome_input">
                    <span>Nivel de acesso:</span>
                    <select name="name-select-acesso" class="select-acesso" id="select_tipoUsuario">
                        <option value="#" default>Selecione</option>
                        <option value="1">Gerente</option>
                        <option value="2">Analista</option>
                    </select>
                    <span>Email:</span>
                    <input type="text" id="input_email">
                    <span>Senha:</span>
                    <input type="password" id="input_senha">
                </div>
                <button onclick="cadastrarFunc()" class="cadastrarFunc">Cadastrar</button>
            </div>

            <!-- Fim - Inputs -->

            <!-- Inicio - Lista Func -->
            <div class="funcionario_cadastrado">
                <h2>Funcionarios Cadastrados:</h2>
                <div id="div_lista_funcionarios">

                    <!-- LISTA DE FUNCIONARIOS  listarFunc() -->

                </div>
            </div>
            <!-- Fim  - ListaFunc -->
        </div>
    </div>

    </div>
</body>

<script>
    var fkEmpresaVar = sessionStorage.FK_EMPRESA
    var SessionUser = sessionStorage.NOME_USUARIO

    const menuButton = document.getElementById('imgOpenMenu');
    const menu = document.getElementById('menu');
    const closeButton = document.getElementById('imgCloseMenu');

    menuButton.addEventListener('click', () => {
        menu.classList.toggle('open');
    });

    closeButton.addEventListener('click', () => {
        menu.classList.remove('open');
    });

    document.addEventListener('click', (event) => {
        if (!menu.contains(event.target) && event.target !== menuButton) {
            menu.classList.remove('open');
        }
    });



    function cadastrarFunc() {
        var nomeVar = document.getElementById('nome_input').value;
        var emailVar = document.getElementById('input_email').value;
        var senhaVar = document.getElementById('input_senha').value;
        var tipoUserVar = document.getElementById('select_tipoUsuario').value;


        // Verificando se há algum campo em branco
        if (
            nomeVar == "" ||
            emailVar == "" ||
            senhaVar == "" ||
            tipoUserVar == "#" ||
            fkEmpresaVar == ""
        ) {
            alert("Preencha todos os campos! " + fkEmpresaVar)


        } else {

            fetch("/usuarios/cadastrarFunc", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({

                    nomeServer: nomeVar,
                    emailServer: emailVar,
                    senhaServer: senhaVar,
                    tipoUserServer: tipoUserVar,
                    fkEmpresaServer: fkEmpresaVar,

                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);

                    if (resposta.ok) {
                        listarFunc()
                    } else {
                        throw "Houve um erro ao tentar realizar o cadastroFunc!";
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);

                });
        }

        return false;
    }


    function listarFunc() {

        // Enviando o valor da nova input
        fetch(`/usuarios/listarFunc/${fkEmpresaVar}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {
                resposta.json().then((funcionarios) => {
                    console.log(funcionarios)
                    funcionarios.forEach((funcionario) => {
                        div_lista_funcionarios.innerHTML += `
                    <div class="funcionario">
                        <div id="info_funcionario">
                            <span id="nome-func">${funcionario.Nome}</span>
                            <span id="cargo-func">${funcionario.tipo}</span>
                        </div>
                        <img src="../assets/imgs/editar-branco.png" alt="editar" onclick="abrirEPreencher(${funcionario.idUsuario})">
                    </div>`
                            ;
                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function pegarDados(idUsuario) {
        return fetch(`/usuarios/pegarDados/${fkEmpresaVar}/${idUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((resposta) => resposta.json())
            .catch((erro) => {
                console.error(`#ERRO: ${erro}`);
                throw erro; // Propaga o erro
            });
    }


    function abrirModal() {
        sombraDiv.style.display = `unset`;
        modalDiv.style = "display: unset";
    }

    function abrirEPreencher(idUsuario) {
        pegarDados(idUsuario)
            .then((funcionario) => {
                // Preenche os campos com os dados recebidos
                var recebeNome = funcionario[0].Nome || "falhou";
                var recebeTipo = funcionario[0].fkTipoUsuario || "falhou";
                var recebeEmail = funcionario[0].Email || "falhou";
                var recebeSenha = funcionario[0].Senha|| "falhou";
                
                document.getElementById('nome_input').value = recebeNome;
            document.getElementById('input_email').value = recebeEmail;
            document.getElementById('input_senha').value = recebeSenha;
            document.getElementById('select_tipoUsuario').value = recebeTipo;

                console.log(recebeNome)
                console.log(recebeEmail)
                console.log(recebeSenha)
                console.log(recebeTipo)

                abrirModal(); // Abre o modal após preencher os dados
            })
            .catch((erro) => {
                console.error("Erro ao abrir o modal:", erro);
            });
    }

    function sairModal() {
        sombraDiv.style.display = `none`;
        modalDiv.style.display = `none`;
    }

</script>

</html>

